@model ForumApp.Models.Forum

<!-- Include your custom CSS -->
<link rel="stylesheet" type="text/css" href="~/Content/Forum/ForumDetails.css" />

<div class="forum-details">
    <h2 class="forum-title">@Model.Title</h2>
    <p class="forum-description">@Model.Description</p>

    <h3 class="section-title">Posts</h3>

    @if (Model.Posts.Any(p => p.IsApproved))
    {
        <table id="postsTable" class="table table-striped table-hover table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>@Html.DisplayNameFor(m => m.Title)</th>
                    <th>Content</th>
                    <th>Date Created</th>
                    <th>Comments</th>
                    <th>User</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var post in Model.Posts.Where(p => p.IsApproved))
                {
                    <tr>
                        <td>@Html.ActionLink(post.Title, "Details", "Posts", new { id = post.PostId }, null)</td>
                        <td>@post.Content</td>
                        <td>@post.DateCreated.ToString("MMMM dd, yyyy")</td>
                        <td>
                            @post.Comments.Count
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                @Html.ActionLink(post.User.UserName, "Index", "Profile", new { id = post.UserId }, new { @class = "username-link text-dark" })
                                <img src="@post.User.ProfilePictureUrl" alt="Profile Picture" class="profile-picture ml-2" style="width:40px; height:40px;" />
                            </div>
                        </td>
                        <td>
                            <button data-post-id="@post.PostId" class="btn btn-sm btn-danger js-delete">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">No posts yet. Be the first to post!</p>
    }

    <div class="my-4">
        @Html.ActionLink("Create New Post", "Create", "Posts", new { forumId = Model.ForumId }, new { @class = "btn btn-primary" })
        @Html.ActionLink("Back to Forum List", "Index", null, new { @class = "btn btn-secondary ml-2" })
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle post submission confirmation via URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('postSubmitted') === 'True') {
                bootbox.alert({
                    title: "Post Submitted",
                    message: "Your post has been successfully submitted!",
                });
            }

            // Initialize DataTables for post listing
            var table = $('#postsTable').DataTable();

            // Delete post functionality
            $("#postsTable .js-delete").on("click", function () {
                var button = $(this);
                bootbox.confirm("Are you sure you want to delete this post?", function (result) {
                    if (result) {
                        $.ajax({
                            url: "/Posts/DeletePost/" + button.attr("data-post-id"),
                            method: "GET",
                            success: function () {
                                table.row(button.parents("tr")).remove().draw();
                            },
                            error: function (err) {
                                console.log(err);
                            }
                        });
                    }
                });
            });
        });
    </script>
}

